{% extends 'base.html' %}
{% load static %}

{% block head %}
    <title>Stock Management System</title>
    <link rel="stylesheet" href="{% static 'css/stockpage.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
{% endblock %}

{% block body %}
    <div class="container">
        <header class="page-header">
            <h1>Stock Management</h1>
        </header>
        
        <!-- Stock Form - Hidden by default -->
        {% if update %}
            <div id="stock-form-container" class="stock-form-container stock-form-container visible">
                <div class="form-header">
                    <h2><i class="form-icon">✏️</i> Update Stock</h2>
                    <a href="{% url 'stock_page' %}" class="form-close">&times;</a>
                </div>
                <form method="post" action="{% url 'update_stock' stock_id=stock_id %}" class="stock-form">
                    {% csrf_token %}
                    <input type="hidden" name="stock_id" value="{{ stock_id }}">
                    <input type="hidden" name="card" value="{{ card }}">
                    
                    <div class="form-group">
                        <label for="card_name">Card Name:</label>
                        <input type="text" id="card_name" name="card_name" value="{{ card.card_name }}" >
                    </div>

                    <div class="form-group">
                        <label for="card_price">Card Price:</label>
                        <input type="text" id="card_price" name="card_price" value="{{ card.card_price }}"> 
                    </div>
                    
                    <div class="form-group">
                        <label for="stock_quantity">Stock Quantity:</label>
                        <input type="number" id="stock_quantity" name="stock_quantity" value="{{ update_stock.stock_quantity }}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reorder_level">Reorder Level:</label>
                        <input type="number" id="reorder_level" name="reorder_level" value="{{ update_stock.reorder_level }}" required>
                    </div>
                
                    <div class="form-actions">
                        <button name='button' value='update-changes' type="submit" class="btn-primary">Update Stock</button>
                        <a href="{% url 'stock_page' %}" class="btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        {% else %}
            <div id="stock-form-container" class="stock-form-container">
                <div class="form-header">
                    <h2><i class="form-icon">+</i> Add Stock Details</h2>
                    <button id="form-close" class="form-close">&times;</button>
                </div>
                <form method="post" action="" class="stock-form">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label for="card_input">Select Card:</label>
                        <input type="text" id="card_input" name="card_input" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="card_price">Card Price:</label>
                        <input type="number" step="0.01" id="card_price" name="card_price" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="stock_quantity">Stock Quantity:</label>
                        <input type="number" id="stock_quantity" name="stock_quantity" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reorder_level">Reorder Level:</label>
                        <input type="number" id="reorder_level" name="reorder_level" required>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">Add Stock</button>
                    </div>
                </form>
            </div>
        {% endif %}
        
        <!-- Stock List -->
        <div class="stock-container">
            <div class="stock-header">
                <div class="stock-stats">
                    <p class="stock-count"><span>{{ stocks.count }}</span> items in stock</p> 
                    {% if search_query %}
                        <p class="search-info">Search results for "<strong>{{ search_query }}</strong>" in column "<strong>{{ selected_column }}</strong>"</p>
                    {% endif %}
                </div>
            </div>

            <div class="stock-search">
                <form method="get" action="" class="search-form">
                    <div class="search-group">
                        <label for="search-column">Search by:</label>
                        <select id="search-column" name="column">
                            <option value="card__card_name" {% if selected_column == 'card__card_name' %}selected{% endif %}>Card Name</option>
                            <option value="card__card_code__item_code" {% if selected_column == 'card__card_code__item_code' %}selected{% endif %}>Card Code</option>
                            <option value="stock_quantity" {% if selected_column == 'stock_quantity' %}selected{% endif %}>Stock Quantity</option>
                            <option value="reorder_level" {% if selected_column == 'reorder_level' %}selected{% endif %}>Reorder Level</option>
                            <option value="updated_by__username" {% if selected_column == 'updated_by__username' %}selected{% endif %}>Updated By</option>
                        </select>
                    </div>
                    <div class="search-group">
                        <label for="search-input">Value:</label>
                        <input type="text" id="search-input" name="search" {% if search_query %}value="{{ search_query }}"{% endif %} placeholder='Enter search term...' required>
                    </div>
                    <div class="search-actions">
                        <button type="submit" class="search-button">Search</button>
                        <a href="{% url 'stock_page' %}" class="reset-button">Reset</a>
                    </div>
                </form>
            </div>
            
            <div class="table-container">
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th class="col-code">Card Code</th>
                            <th class="col-name">Card Name</th>
                            <th class="col-price">Card Price</th>
                            <th class="col-stock">Stock Quantity</th>
                            <th class="col-reorder">Reorder Level</th>
                            <th class="col-updated">Last Updated</th>
                            <th class="col-updated-by">Updated By</th>
                            <th class="col-actions" colspan="2">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stock in stocks %}
                        <tr {% if stock.stock_quantity is None or stock.reorder_level is None %}id="no-stock-row"{% endif %}>
                            <form method="post" action="{% url 'delete_stock' %}">
                                {% csrf_token %}
                                <input type="hidden" name="card" value="{{ stock.card.id }}">
                                <input type="hidden" name="stock_id" value="{{ stock.id }}">
                                <td class="col-code">{{ stock.card.card_code.item_code }}</td>
                                <td class="col-name">{{ stock.card.card_name }}</td>
                                <td class="col-price">${{ stock.card.card_price }}</td>
                                <td class="col-stock">
                                    {% if stock.stock_quantity is not None %}
                                        {{ stock.stock_quantity }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="col-reorder">
                                    {% if stock.reorder_level is not None %}
                                        {{ stock.reorder_level }}
                                    {% else %}
                                        -
                                    {% endif %}</td>
                                <td class="col-updated">{{ stock.last_updated|date:"Y-m-d" }}</td>
                                <td class="col-updated-by">{% if stock.updated_by %}{{ stock.updated_by.username }}{% else %}-{% endif %}</td>

                                {% if stock.stock_quantity is not None or stock.reorder_level is not None %}
                                    <td class="col-action">
                                        <button name="button" value="update" type="submit" class="btn-update">Update</button>
                                    </td>
                                    <td class="col-action">
                                        <button class="btn-delete" name="button" value="delete" type="submit">Clear</button>
                                    </td>
                                {% else %}
                                    <td class="col-action" colspan="2">
                                        <button name="button" value="update" type="submit" class="btn-update" >Update</button>
                                    </td>
                                {% endif %}
                                
                            </form>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="no-records">No stock items found. Add new stock to get started.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="{% static 'js/stockpage.js' %}"></script>
{% endblock %}